\chapter{Computational cytomorphology of haematological conditions}

\section{Contribution and disclaimer}

In this chapter I used the method developed and applied in the last chapter to two distinct cohorts of \ac{wbs} and develop methods that enable the prediction of clinically relevant conditions from the distributions of features within \ac{wbs} and using individual cells. I also outline \ac{mile-vice}, a weakly-supervised \ac{ml} framework to cluster cells into virtual cell types, and show how this can be used to derive cellular archetypes that are enriched in specific conditions, enabling the discovery of novel and clinically relevant morphological phenotypes. I note here that, for the remainder of this dissertation, \textit{virtual cell types} describes types of cell derived using computational methods, whereas \textit{cellular archetypes} describe the morphological description of virtual cell types associated with specific clinical conditions.

\section{Introduction}

\ac{mds} are a heterogeneous group of myeloid neoplasms. The characterization of \ac{mds} encompasses several distinct clinical observations: consistently decreased numbers of mature blood cells (cytopenia) associated with a decreased ability of the bone marrow to produce blood cells (bone marrow failure), identification of blood cells from one or more specific lineages with abnormal cytomorphology (dysplasia) and an increase in the probability of \ac{aml} onset due to genetic instability \cite{Valent2017-uh,Hofmann2005-vv,Aster2020-cu}. In other words, \ac{mds} are simultaneously an oncological malignancy and a precursor to more severe forms of cancer. This highlights \ac{mds} as an integral part of blood cancer evolution and how its detection and treatment are critical to prevent the development of more serious haematooncological conditions --- one of the key features separating \ac{aml} from \ac{mds} is that the former is characterized by a much higher prevalence of bone marrow blasts (>20\%); in other words, when \ac{mds} leads to a more considerable expansions of blasts, it is more likely that it will become \ac{aml} \cite{Klepin2016-xg}.

\paragraph{Expert diagnosis of myelodysplastic syndromes.} The diagnosis of \ac{mds} is done through a number of complementary assessments and analyses. \Ac{cbc}, generally obtained through the use of an automated blood counter and can detect cytopenias (reduction in circulating mature blood cells) such as anaemias, leukopenias and/or thrombocytopenias (cytopenias affecting \ac{rbc}, \ac{wbc} and platelets, respectively), all of which are common in \ac{mds} \cite{Najean1989-qm,Campo2017-wi}. Megaloblastic anaemias, in particular, can be indicative of or easily confounded with \ac{mds} \cite{Kaferle2009-pl,Vasekova2016-vo,Corey2007-cs}. The analysis of \ac{wbs} or bone marrow slides with different stains allows the detection of specific dysplastic features in blood cells. The former allows the characterization of abnormalities such as granulocytes with reduced nuclear lobulation, abnormal granularity in neutrophils or abnormal \ac{rbc} (such as macrocytes, elliptocytes and dacrocytes) \cite{Campo2017-wi,Langenhuijsen1984-qx,Kuriyama1986-ts,Davey1988-zn}. The analysis of bone marrow slides enables the identification of abnormal cell maturation or an excessive count of blasts \cite{Aster2020-cu}. Cytochemistry and immunohistochemistry can also be used with bone marrow slides and allows the identification of, among others, ring sideroblasts, which define a subtype of \ac{mds} \cite{Campo2017-wi,Mufti2008-ye}. Additionally, flow cytometry, cytogenetic characterization and molecular sequencing are necessary for the classification of \ac{mds} \cite{Aster2020-cu,Porwit2014-zi,Greenberg2012-en}, with multiparametric flow cytometry being often times considered essential for the diagnosis of \ac{mds} \cite{Cremers2016-fs}.

\paragraph{Confounders in \ac{mds} diagnostic and the relevance of \ac{sf3b1} mutation status in prognosis.} \Ac{mds} can be complicated to diagnose when little information is available --- as mentioned, anaemias are a common symptom of \ac{mds}, but can be caused by multiple reasons such as nutrient deficiency \cite{Castle1978-ky,Short2013-pz,Aslinia2006-en}. In other words, anaemias can be a symptom of \ac{mds} or caused by other, non-oncological factors and diagnosing between anaemias and \ac{mds} from a \ac{wbs} alone is non-trivial and unfeasible in a clinical setting. Additionally, \ac{mds} subtypes characterized by specific mutations can be hard to characterize when no molecular sequencing or bone marrow slides are available. Such a \ac{mds} subtype is \ac{sf3b1}, characterized clinically by longer survival times \cite{Malcovati2020-no} and morphologically by the presence of ring sideroblasts in the bone marrow using specific stains that allow their identification \cite{Hellstrom_Lindberg2015-zs}. However, no morphological phenotypes have been identified for \ac{sf3b1}-mutant \ac{mds} in the blood. Considering the clinical relevance of this mutation, it is important to better understand the cytomorphological manifestations of \ac{sf3b1}-mutant \ac{mds} in the blood. Computational methods such as the ones outlined in Chapter 4 and in the present Chapter can represent a strategy to identify novel cellular archetypes for specific conditions.

\paragraph{Computational cytomorphology approaches to \ac{mds} diagnosis.} A recent work showed how previously established and expert-derived cytomorphological descriptions of \ac{wbs} could be used to classify \ac{mds} into specific and genomically-relevant subtypes with limited concordance in a validation cohort \cite{Nagata2020-lh}. While this approach can be potentially useful, it represents a laborious and time-consuming task for the trained expert. Additionally, the subpar inter-individual concordance in classifying cell types can hinder the possibility for finer-grained identification of cytomorphological determinants of \ac{mds} subtypes, novel or otherwise. Other studies have shown how the analysis of bone marrow slides using \ac{dl} can be leveraged to not only classify diseases, but also to detect the presence of specific mutations in both \ac{aml} and \ac{mds} \cite{Bruck2021-fx,Eckardt2021-fb}. These approaches are mostly possible due to the elevated density of nucleated cells in bone marrow: this guarantees that high resolution images (50x) with a relatively small size (2560*1920 pixels) are representative of the whole bone marrow as in \cite{Eckardt2021-fb}.  \etal{Bruck} also use this high cellular density to their advantage by splitting relatively large bone marrow slides into small image tiles and training a \ac{dl} model at this level (224x224 and 299x299) \cite{Bruck2021-fx}. The low density of nucleated cells in \ac{wbs} makes these approaches unfeasible.

In this work, I used computational cytomorphology to predict different conditions and identify novel cellular phenotypes associated with each. For this, I defined four distinct tasks to assess how well computational cytomorphology could be used to predict different clinical conditions based on the data available from the MLLC:

\begin{enumerate}
    \item Disease detection --- identifying the presence of either anaemia or \ac{mds} (easy for trained experts);
    \item Disease classification --- distinguishing between anaemia and \ac{mds} (hard for trained experts --- anaemia can be a symptom of \ac{mds});
    \item \ac{sf3b1} mutation \ac{mds} detection --- distinguishing between \ac{sf3b1}-mutant \ac{mds} and other subtypes of \ac{mds} (hard for trained experts --- no known morphological manifestation of \ac{sf3b1} mutations exist);
    \item Anaemia classification --- distinguishing between iron deficiency anaemia and megaloblastic anaemia (easy for trained experts).
\end{enumerate}

In addition to the cytomorphological features already described, I also had access to a few \ac{cbc} parameters, particularly \ac{wbcc} (\ac{wbc}/\Mum), haemoglobin concentration (g/dL) and platelet counts (platelets/\Mum). Here, I also assessed their impact on the predictive performance of all the classification methods. For clarity, I do not report training metrics and focus exclusively on cross-validated metrics or external validation metrics.

\section{Representative blood count trends}

To confirm that the MLLC is a representative cohort, I started by analysing a few simple aspects of this cohort. Particularly, I started by confirming that individuals with \ac{mds} are generally much older than the rest of the population with a particular bias towards male individuals, as previously reported \cite{Rollison2008-yg}. Indeed, the chance of having \ac{mds} in our cohort increases by 12\% every year, with male individuals being more than twice as likely to contract \ac{mds} (according to a binomial regression with binary \ac{mds} status as the dependent variable and age and sex as the covariates, $p=8*10^{-16}$ and $p=0.00017$, respectively; \figref{fig:mds-age} and \figref{fig:mds-sex}). While recapitulating these patterns confirms that our cohort is representative, it also prevents us from using both parameters as features in predictive modelling as they might bias the results.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mllc-age}
    \placecaption{Age distribution for the different conditions in MLLC.}
    \label{fig:mds-age}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mllc-sex}
    \placecaption{Sex distribution for the different conditions in MLLC.}
    \label{fig:mds-sex}
\end{figure}

I additionally observed that individuals with either \ac{mds} or anaemia have a tendency to be leukopenic, with individuals having approximately 1,200 and 1,800 fewer \ac{wbc}/\Mum in these conditions, respectively (according to a linear regression where WBC count is the dependent variable and binary status as \ac{mds} and anaemia are the dependent variables, $p=0.04$ and $p=0.009$, respectively, for \ac{wbcc} coefficient t-tests; \figref{fig:mds-wbcc}). However, this leukopenic tendency in anaemias is driven by individuals with megaloblastic anaemia --- indeed, whereas iron-deficient individuals are indistinguishable from normal individuals, individuals with megaloblastic anaemia have approximately 3,200 WBC/\Mum{} fewer than normal individuals ($p=6 \times 10^{-14}$ for a two sample t-test) --- an effect that has been reported elsewhere and that can be associated with folic acid or vitamin B12 deficiencies \cite{Kaferle2009-pl,Castle1978-ky} and that further highlights how megaloblastic anaemias can be confounded with \ac{mds}. Haemoglobin concentrations are also much lower in \ac{mds} and, expectedly, anaemias (\figref{fig:mds-hb}) --- indeed, these individuals have 4.34 and 6.38 fewer haemoglobin g/dL, respectively (according to a linear regression where Hb concentration is the dependent variable and binary status as \ac{mds} and anaemia are the dependent variables, $p<2.2 \times 10^{-16}$ and $p<2.2 \times 10^{-16}$, respectively, for haemoglobin concentration coefficient t-tests). No detectable difference between normal individuals and individuals with either \ac{mds} or anaemia is observable when it comes to platelet counts, but it should be noted that individuals with megaloblastic anaemia have approximately an expected 146,000 fewer platelets/\Mum{} than normal individuals ($p=3 \times 10^{-12}$ for a two sample t-test; \figref{fig:mds-plt}), concordant with previous reports \cite{Castle1978-ky}. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/mllc-wbcc}
    \placecaption{White blood cell count distribution for the different conditions in MLLC.}
    \label{fig:mds-wbcc}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mllc-hb}
    \placecaption{Haemoglobin concentration distribution for the different conditions in MLLC.}
    \label{fig:mds-hb}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mllc-platelet}
    \placecaption{Platelet count distribution for the different conditions in MLLC.}
    \label{fig:mds-plt}
\end{figure}

Finally, I also observe that \ac{sf3b1}-mutant \ac{mds} presents clinically distinct features from other \ac{mds} subtypes --- particularly, WBC and platelet counts are indistinguishable from those of normal individuals while being much higher than those found in other \ac{mds} subtypes ($p=0.34$ and $p=0.15$ for two sample t-tests comparing \ac{wbcc} and platelet counts between individuals with \ac{sf3b1}-mutant \ac{mds} and normal individuals; $p=0.0017$ and $p<2.2 \times 10^{-16}$ for two sample t-tests comparing \ac{wbcc} and platelet counts, respectively, between individuals with \ac{sf3b1}-mutant \ac{mds} and individuals with other \ac{mds} subtypes in our cohort). This is in agreement with what has been previously described in terms of higher platelet and absolute neutrophil counts in \ac{sf3b1}-mutant \ac{mds} \cite{Malcovati2015-tz,Malcovati2020-no} and further highlights the relevance of being able to discriminate between this and other \ac{mds} subtypes. 

\section{Disease classification with morphometric moments}

I define morphometric moments as parametric characterizations of the distribution of each feature within each \ac{wbs}. For each \ac{wbs} and cell type (\ac{rbc} and \ac{wbc}), each feature is characterized by:

\begin{itemize}
    \item Its first moment (its mean)
    \item Its second moment (its variance).
\end{itemize}

With this, I obtain a relatively simple characterization of the distribution of each feature on each slide, which can be used in predictive modelling tasks as features. To ensure that my estimates for the mean and variance of each feature are adequate, I exclude all cases where fewer than 50 \ac{wbc} or \ac{rbc} were detected. Consequently, for the classification methods, my input was, for each individual, a morphometric moment --- a vector containing the mean and variance of each feature. This constitutes, for the cytomorphological features, a total of ($53 + 42) \times 2 = 190$ features considering both \ac{wbc} (mean and variance of 53 feaures) and \ac{rbc} (mean and variance of 42 feaures) which, when combined with the \ac{cbc} data, yielded a total of 193 features. To get different baselines, I defined three datasets --- one composed of \ac{cbc} features (3 features), one composed of cytomorphological features (190) and one composed of both feature types (193). 

\subsection{Assessment of the predictive ability of individual morphometric moments}

To get a sense on whether the retrieved features could be useful in classification, I first aggregated them on a per-individual basis by calculating the mean and variance of each feature for each cell type (\ac{rbc} and \ac{wbc}), generating what I call morphometric moments. I then used a relatively simple statistical pipeline to test whether there were significant differences between different clinical conditions on MLLC (normal individuals, individuals with iron deficiency anaemia, individuals with megaloblastic anaemia, individuals with \ac{sf3b1} \ac{mds} and individuals with other \ac{mds} subtypes): first, I perform a Kruskal-Wallis test --- an extension of the Mann-Whitney U-test (a sum of ranks based non-parametric test that tests whether a set of samples originate from the same distribution) for multiple samples --- on each individual feature. Then, considering only the features for which the Kruskal-Wallis test was significant after correcting for multiple testing, I performed a post-hoc Dunn test --- a pairwise sum of ranks test for multiple groups that tests if each group pair originates from the same distribution --- to determine how many features are relevant for each comparison (if $p<0.05$ after multiple testing correction).

\paragraph{Morphological distributions are different between conditions.} This analysis shows that, for most cases, a considerable amount of features has sufficient discriminatory power to discriminate between conditions (\figref{fig:dunn-test-heatmap}). I note here that for the remainder of this paragraph I consider a feature to be significant if either its mean or variance is significant. Identifying the presence of a clinically-relevant condition is the easier task, with at least 42 features (79.2\%) and 22 features (52.4\%) offering discriminatory power for \ac{wbc} and \ac{rbc}, respectively. Additionally, discriminating between \ac{mds} and anaemia is a relatively easy task (at least 38 features (71.7\%) and 20 features (47.6\%) for \ac{wbc} and \ac{rbc}, respectively). Finally, it is worth noting that the greatest challenge --- i.e. the comparison for which there are fewer significant features --- lies in the discrimination between \ac{sf3b1}-mutant \ac{mds} and other \ac{mds} subtypes, with 19 features (35.8\%) and 23 features (54.8\%) for \ac{wbc} and \ac{rbc}, respectively. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/dunn-test-heatmap}
    \placecaption{Number of statistically significant features which offer good discriminating power for white blood cell means and variances (top left and top right, respectively), red blood cell means and variances (bottom left and bottom right). Colours represent the percentage of features which are statistically significant.}
    \label{fig:dunn-test-heatmap}
\end{figure}

Finally, inspecting the distributions of the two most discriminating features (largest Kruskal-Wallis statistic) reveals already striking differences between features depending on the condition (\figref{fig:feature-distribution-mean}). Regarding the mean of \ac{wbc} features, a decrease on both the ellipse variance (i.e. how distinct a shape is from an ellipse) and the first moment of the \ac{cdf} (a relatively abstract quantifier of shape irregularity) are typical of anaemia or \ac{mds} ($p=2 \times 10^{-14}$ and $p=8 \times 10^{-16}$ for Mann-Whitney tests comparing the distributions of the means of the ellipse variance and the first moment of the \ac{cdf}, respectively, for normal individuals and individuals with a clinically-relevant condition). These features can also be used to discriminate between both types of anaemia ($p=4 \times 10^{-4}$ and $p=2 \times 10^{-4}$ for Mann-Whitney tests comparing distributions of the means of the ellipse variance and the first moment of the \ac{cdf}, respectively, for individuals with either iron deficiency or megaloblastic anaemia; \figref{fig:feature-distribution-mean} (top) and \figref{fig:feature-distribution-mean-examples} (top)). The mean of \ac{rbc} features shows that individuals with \ac{sf3b1}-mutant \ac{mds} have \ac{rbc} with larger perimeters (which can be indicative of large size or shape irregularities) and smaller minimum values for the \ac{cdf} (which can be indicative of smaller sizes or shape irregularities; $p=3 \times 10^{-13}$ and $p=10^{-5}$ for Mann-Whitney tests comparing the distributions of the perimeter and minimum value of the \ac{cdf}, respectively; \figref{fig:feature-distribution-mean} (bottom) and \figref{fig:feature-distribution-mean-examples} (bottom)).

\begin{figure}[!ht]
    \placefigure{cytomorphology/top-features-kw}
    \placecaption{Examples of the two most discriminating features for white blood cell (top) and red blood cells (bottom) stratified by clinically-relevant condition.}
    \label{fig:feature-distribution-mean}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/feature-distribution-mean-examples}
    \placecaption{Examples for low and high values for the first noiseless moment of the centroid distance function (CDF) in white blood cells (top) and cell perimeter in red blood cells.}
    \label{fig:feature-distribution-mean-examples}
\end{figure}

\subsection{Morphometric moments as features in supervised learning}

\subsubsection{Methods}

These results show the potential of morphometric moments for diagnostic. However, they also reveal complex relationships between features --- in \ac{rbc}, the perimeter and minimum value of the \ac{cdf} can both be indicative of size but are increased and decreased, respectively, when comparing \ac{sf3b1}-mutant \ac{mds} with other \ac{mds} subtypes. To study these relationships, I started by splitting the data into 5 non-overlapping test sets using a stratified cross-validation scheme, thus ensuring that each training and validation sets had a sufficient number of each class. Following this, I preprocessed the data on each training set in order to standardize it and remove features which are highly correlated with other features ($|R|>0.9$). Additionally, and considering that \ac{cbc} was available for all individuals, I imputed the missing values for \ac{cbc} data using the median for each parameter. I trained two different models for each round of cross-validation --- a binomial regression model with an elastic network regularization (a weighted combination of the $L1$ and $L2$ regularizations) as implemented in the \texttt{glmnet} package for R \cite{Friedman2010-gl} and a random forest model \cite{Breiman2001-yz}. Random forests are ensemble models which combine the weighted predictions from several decision trees trained on a random subset of data and features. The random nature of the training makes them extremely robust to overfitting since it prevents a subset of data or of features from having a disproportionate amount of effect on the trained model. To deal class imbalance I weighted the objective of each sample of $\mathrm{class}_i$ by $1-\frac{\mathrm{number\ of\ elements\ in\ class}_i}{\mathrm{total\ number\ of\ elements}}$. 

After training each model, I calculated the \ac{auroc} by using the concatenated results from all cross-validation rounds to obtain the cross-validated \ac{auroc} \cite{Fawcett2006-mo}. However, for inference and assessment of feature importance I selected the best performing model out of each set of cross-validated models. I assessed the feature importance for the binomial regression by calculating the standardized value for each coefficient and for the random forests by using the mean decrease in accuracy as recommended by Breiman in the original paper describing random forests \cite{Breiman2001-yz}. To assess the importance of a group of features --- the total explained variance for each group --- I used the trained binomial regression model and calculate the effect of each group of variables by summing the effects of the standardized variables composing it for each individual. Finally, I calculated the total explained variance by each group of features by calculating the sum of the rows in the covariance matrix between all 5 groups of features --- \ac{wbc} feature means, \ac{wbc} feature variances, \ac{rbc} feature means, \ac{rbc} feature variances and \ac{cbc} parameters.

\subsubsection{Morphometric moments predict clinically-relevant conditions}

\paragraph{A simple linear model for disease prediction.} I assessed which of the models offered the best performance as this can reveal important aspects of how features are associated with one another. Particularly, while a \ac{rf} model is capable of capturing both linear and non-linear relationships, an elastic network model assumes that the relationship between each variable and the label is linear. In \figref{fig:glmnet-vs-rf-auc} and using both the morphometric moments and blood count data I showed that the elastic regression model outperforms the \ac{rf} model for disease detection and classification, while being slightly worst for \ac{sf3b1} mutation detection. Additionally, both perform equally well on the task of anaemia classification. The poorer performance of the \ac{rf} model suggests that the relationships between features are unlikely to be non-linear. I carry on with the elastic regression model, which has the added advantage of allowing the simple calculation of feature group importance.

\begin{figure}[!ht]
    \placefigure{cytomorphology/glmnet-vs-rf-auc}
    \placecaption{Cross-validated AUROC for the elastic regression model (glmnet; green) and random forest model (RF; dark red) for the different tasks considered. The average value for each model-task combination is shown as a slanted square.}
    \label{fig:glmnet-vs-rf-auc}
\end{figure}

I then trained models using only blood counts, only morphology (morphometric profiles), or both. I showed that morphology performs similarly or outperforms blood counts, with a considerable improvement when considering disease classification and disease detection (\figref{fig:roc-curves-binary} and \figref{fig:auc-binary}), where using only blood counts for prediction performs considerably worst. Importantly, I note that in all cases the performance is tendentially best when using both types of data. Interestingly, using blood counts alone is relatively effective at detecting the presence of a \ac{sf3b1} mutation in an individual with \ac{mds} (AUC = 82.9\%), a performance that is driven largely by the increased platelet counts in individuals with \ac{sf3b1}-positive \ac{mds}.

\begin{figure}[!ht]
    \placefigure{cytomorphology/roc-curves-binary}
    \placecaption{Cross-validated receiver operating characteristic curves for the four tasks considered. Coloured depending on the data type used --- blood counts (B.C.), morphology or both (morphology + B.C.).}
    \label{fig:roc-curves-binary}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/auc-binary}
    \placecaption{AUROC values for the four tasks considered. Coloured depending on the data type used --- blood counts (B.C.), Morphology or both (Morphology + B.C.). Black lines represent 95\% confidence intervals.}
    \label{fig:auc-binary}
\end{figure}

\paragraph{Feature importances reveal disease-associated morphometric moment trends.} Inspecting how different features impact prediction using both blood counts and morphology can reveal some important trends. For instance and for disease detection, lower haemoglobin levels, an excess of average \ac{rbc} eccentricity (the ratio between major and minor axes) and average \ac{wbc} nuclear green mass displacement (measures how much the red colour distribution is shifted from the centre, thus quantifying nuclear irregularities) contributes considerably to the "normal" classification (\figref{fig:feature-importance-disease-detection-classification} (left)). Within individuals with a disease (anaemia or \ac{mds}), it becomes clear that low platelet and \ac{wbc} counts, together with high haemoglobin concentration are hallmarks of \ac{mds}. An increase in the average \ac{rbc} perimeter, decrease in the average \ac{wbc} nuclear eccentricity, an increase in the variance of \ac{wbc} solidity (the ratio between the object and its convex hull, quantifying deformations to the shape) can also be important in diagnostic of \ac{mds} (\figref{fig:feature-importance-disease-detection-classification} (right)).

\begin{figure}[!ht]
    \placefigure{cytomorphology/feature-importance-disease-detection-classification}
    \placecaption{Standardized coefficients for the five most important features in the elastic network regression (glmnet) model by feature group (blood counts (B.C.), red blood cell mean and variance, white blood cell mean and variance) for disease detection (left) and disease classification (right).}
    \label{fig:feature-importance-disease-detection-classification}
\end{figure}

As for the discrimination between disease subtypes, this analysis shows that, for the most part, high platelet counts are indicative of \ac{sf3b1}-mutant \ac{mds} (\figref{fig:feature-importance-mds}) as observed earlier in \figref{fig:mds-plt}. Additionally, an increase in the average \ac{rbc} perimeter is also predictive of \ac{sf3b1}-mutant \ac{mds}. Regarding the classification of different anaemia subtypes, an increase in platelet counts is expected in iron deficiency anaemia, whereas an increase in the \ac{rbc} average minimum of the minor axis peak profile (a measure of the colour distribution along the major axis of the cell) is expected in megaloblastic anaemia \figref{fig:feature-importance-anaemia}. This can point towards a greater prevalence of spherocytes in iron deficiency anaemia. Additionally, a seemingly unintuitive finding which will be further confirmed ahead is that morphological aspects of \ac{wbc} --- particularly concerning the nuclei of \ac{wbc} --- contribute heavily towards the classification of different subtypes of anaemia. However, this can be explained by the fact that hyperlobulated neutrophils --- neutrophils with more than 5 nuclear lobules --- are known to be overrepresented in \ac{wbs} in megaloblastic anaemia cases \cite{Hariz2021-qw}.

\begin{figure}[!ht]
    \placefigure{cytomorphology/feature-importance-mds}
    \placecaption{Standardized coefficients for the important features in the elastic network regression (glmnet; abs(coefficient) > 0) model by feature group (blood counts (B.C.), red blood cell mean and variance, white blood cell mean and variance) for \textit{SF3B1} mutation detection.}
    \label{fig:feature-importance-mds}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/feature-importance-anaemia}
    \placecaption{Standardized coefficients for the important features in the elastic network regression (glmnet; abs(coefficient) > 0) model by feature group (blood counts (B.C.), red blood cell mean and variance, white blood cell mean and variance) for anaemia classification.}
    \label{fig:feature-importance-anaemia}
\end{figure}

\paragraph{Morphology and blood counts play important roles in prediction.} Finally, looking at how groups of features impact prediction shows that morphometric moments account for most of the variance explained by these predictive models, with aspects pertaining to both mean and variance playing a significant role (\figref{fig:feature-group-importance}). An obvious exception is the detection of \ac{sf3b1} mutations in individuals with \ac{mds} --- here, it is blood counts, particularly platelet counts, that drive the classification, with \ac{wbc} playing a practically negligible part. This may be due to the fact that \ac{wbc} abnormalities are present only in a few cells in \ac{mds}, making the use of relatively generic distribution descriptors (i.e. mean and variance) not adequate for classification.

\begin{figure}[!ht]
    \placefigure{cytomorphology/feature-group-importance}
    \placecaption{Feature group importance for the prediction of different conditions by feature group (blood counts (B.C.), red blood cell mean and variance, white blood cell mean and variance). Each circle is scaled according to the explained variance.}
    \label{fig:feature-group-importance}
\end{figure}

\paragraph{Morphology outperforms blood counts at discriminating between \ac{sf3b1}-mutant \ac{mds} and iron deficiency anaemia.} Reconsidering this problem as a multiple class problem and training models for each data type further highlights the value of morphology in classification --- the multiple class \ac{auroc} is considerably higher for morphology (91.3\%) than for blood counts only (83.6\%; \figref{fig:multiclass-auc}), an effect driven largely by the poor predictive ability of blood counts in discriminating between \ac{sf3b1}-mutant \ac{mds} and iron deficiency anaemia (AUC = 33\%) and between megaloblastic anaemia and non-\ac{sf3b1}-mutant anaemia (AUC = 72\%; \figref{fig:multiclass-auc-heatmap}). As is the case for the binary classification tasks, using both blood counts and morphology as features offers the best performance (AUC = 93.6\%).

\begin{figure}[!ht]
    \placefigure{cytomorphology/multiclass-auc}
    \placecaption{Multiple class AUROC for elastic network regression models trained on different sets of data to predict the presence of different conditions.}
    \label{fig:multiclass-auc}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/multiclass-auc-heatmap}
    \placecaption{Multiple class pairwise AUROC for different tasks and data types.}
    \label{fig:multiclass-auc-heatmap}
\end{figure}

This section covers the potential of morphometric moments in haematological diagnostic. However, it also highlights an important caveat of this method --- while it is relatively simple to understand what an increase on the average perimeter of \ac{rbc} (as observable in cases of \ac{sf3b1}-mutant \ac{mds} when compared with other \ac{mds} subtypes) or even a decrease in the variability of solidity in \ac{wbc} (as observable in cases of \ac{mds} when compared with anaemias), some of these features do not translate immediately to evident visual features, especially when the variation of these features in a single individual is the relevant aspect of classification. Additionally, as is the case for \ac{sf3b1} mutation detection, alterations may be present in a small subset of cells, rendering morphometric moments less suitable to capturing relevant morphological signatures. For this reason, I developed \ac{mile-vice}, a method capable of creating visually coherent groups of cells which are relevant for disease classification with minimal human input.

\section{MILe-ViCe --- Multiple Instance Learning of Virtual Cell types}

\subsection{Methods}

\subsubsection{Motivation}

While morphometric moments provide a description that is sufficiently good for prediction, they lack the explainability one would expect from an expert analysis of large collections of cells. Typically, when diagnosing \ac{mds}, an expert focuses on identifying abnormal (dysplastic) cell types and on quantifying their relative prevalence \cite{Valent2017-uh}. For example, according to the \ac{ipss-r}, the prevalence of blasts in the \ac{wbs} is key in understanding the risk associated with cases of \ac{mds} \cite{Greenberg2012-en}. In other words, the relative abundance of specific blood cell types is key in haematological diagnostic from a \ac{wbs}. This can be further illustrated here by reducing the morphological space of 50,000 cells to two dimensions using \ac{umap}, a technique which allows the visualization of a high-dimensional data in two dimensions by encoding the data as distance-weighted graph and preserving its local structure in a lower-dimensional space \cite{umap-ref}. In \figref{fig:u-map-condition-density}, I used this two-dimensional representation of my morphometric data to calculate the ratio of cell densities between conditions. This highlights an important aspect of blood cell morphology --- while the morphological space is relatively homogeneous and continuous for both \ac{wbc} and \ac{rbc}, the local prevalence of different cells is different between conditions, implying that the accurate partition of this space can be useful for the prediction of clinical conditions. Additionally, it is evident that these ratios are not the same for each task, highlighting the necessity for a framework capable of not only learning how to predict conditions from the morphological information present in \ac{wbs}, but also to use high-level information, i.e. a clinical condition, to assign each cell into a specific cell type relevant for classification.

\begin{figure}[!ht]
    \placefigurepng{cytomorphology/u-map-condition-density}
    \placecaption{Two-dimensional UMAP representation of the morphological space density ratios between conditions for different comparisons for WBC (top) and RBC (bottom).}
    \label{fig:u-map-condition-density}
\end{figure}

\subsubsection{Multiple instance learning}

While traditional algorithms for supervised \ac{ml}, are dedicated to learning a function that maps a single instance to a class (a one-to-one mapping such as a picture of a cat to the class "cat"), \ac{mil}, a type of supervised \ac{ml}, learns how to map a set of instances to a single class. Essentially, the objective of \ac{mil} algorithms is to take a set of data points --- a bag --- and assign this bag to a class, rather than each individual data point to a class. It is possible to split these methods based on how they handle each individual element (whether they are independent or whether they should be classified individually, for example) and based on how the classification for the bag is calculated (whether the classification should depend on the presence/absence of specific elements or on their relative proportions or whether the interest lies instead in detecting similarity within each bag) \cite{Amores2013-ym,Carbonneau2016-xc}. While problems such as protein sequence classification or sentiment analysis are good examples of \ac{mil} when the bags are inherently structured, I am considerably more interested in the case where no structure is identifiable --- indeed, I am interested in classifying a "bag of cells" stratified by automatically detected \ac{wbc} and \ac{rbc} in a \ac{wbs}. Not only that, but I am also interested in the determination of a vocabulary --- a correspondence between the features that characterize a cell and a \ac{vct}, a computational construct that is morphologically coherent --- that is relevant for the classification task. In the ideal case scenario, this vocabulary-based method would map individual cells to specific classes (i.e. \ac{vct}) and use the proportion of each \ac{vct} to classify a bag as having specific haematological conditions, thus combining good predictive performance with the identification of relevant \ac{vct}. The main advantage of this is that it allows for the discovery of novel cytomorphological signatures which can be adapted to the clinic.

\subsubsection{Model specification}

A given a \ac{wbs} is characterized as a set of $n$ cells $O \in \mathbb{R}^{n \times f}$, where $f$ is the number of morphological features characterizing each cell. I am interested in assigning each of the $n$ cells to one of $v$ \ac{vct}, such that $V = \mathrm{softmax}(O \times \theta_{V},\mathrm{axis}=1)$, where $V \in \mathbb{R}^{n \times v}$ is the membership (between 0 and 1) of all cells to each \ac{vct} and $\theta_{V} \in \mathbb{R}^{f * v}$ are the parameters of the softmax regression assigning each cell to one of $v$ \ac{vct}. The virtual cell composition of the slide $C \in \Delta^{v}$, where $\Delta^{v}$ is the simplex of order $v$, is then calculated as $C=\mathrm{mean}(V,axis=0)$. $C$ is then used to calculate the probability that a \ac{wbs} belongs to an individual with a given disease $d$ as $P(d|C) = \mathrm{sigmoid}(\theta_{C} \times C)$, where $\theta_C$ parametrizes the weights of each \ac{vct} for the classification probability $P(d|C)$.

I characterize the \ac{rbc} $R \in \mathbb{R}^{r \times f}$ and \ac{wbc} $R \in \mathbb{R}^{w \times f}$ in a slide $S$ as separate entities, where $r$ and $w$ are the number of \ac{rbc} and \ac{wbc}, respectively, and $f$ and $g$ are the number of features characterizing each \ac{rbc} and \ac{wbc}, respectively. To do this, I calculate the virtual \ac{rbc} and \ac{wbc} compositions of each slide separately (with $\theta_{R,\mathrm{RBC}} \in \mathbb{R}^{f \times v}$ and $\theta_{R,\mathrm{WBC}} \in \mathbb{R}^{g \times v}$, respectively) and use them to calculate $P(d|C_{\mathrm{RBC}},C_{\mathrm{WBC}}) = \mathrm{sigmoid}(\theta_{C,\mathrm{RBC}} \times C_{\mathrm{RBC}} + \theta_{C,\mathrm{WBC}} \times C_{\mathrm{WBC}})$. This formulation also enables the use of additional information, particularly blood counts (used earlier in this chapter) such that $P(d|C_{\mathrm{RBC}},C_{\mathrm{WBC}},\mathrm{counts}) = \mathrm{sigmoid}(\theta_{C,\mathrm{RBC}} \times C_{\mathrm{RBC}} + \theta_{C,\mathrm{WBC}} \times C_{\mathrm{WBC}} + \theta_{\mathrm{counts}} \times \mathrm{counts})$. Finally, in \figref{fig:mile-vice-schematic}, I present a schematic representation of this model.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-schematic}
    \placecaption{Schematic representation of the MILe-ViCe algorithm. White and red blood cells (WBC and RBC, respectively) are classified as virtual cell types (VCT) and the relative proportions of VCT are used to classify an individual as having a specific and clinically relevant condition.}
    \label{fig:mile-vice-schematic}
\end{figure}

\subsubsection{Model optimization}

I am interested in the concurrent optimization of $\theta_{V,\mathrm{RBC}}$, $\theta_{V,\mathrm{WBC}}$, $\theta_{C,\mathrm{RBC}}$, $\theta_{C,\mathrm{WBC}}$ and $\theta_{C,\mathrm{counts}}$, enabling \ac{mile-vice} to not only learn how to predict conditions from specific \ac{wbs}, but also to learn which \ac{vct} are relevant for each task. Additionally, since \ac{wbs} are composed of thousands or hundreds of thousands of detected cells, I am interested in using a method that enables randomly selected subsets of cells to be used in each training iteration in such a way that converges towards an optimal solution. For this reason I used stochastic gradient descent to optimize \ac{mile-vice}, assuming that there are an equal number of virtual \ac{wbc} and \ac{rbc} types.

I tested each task using different numbers of \ac{vct} --- $[10, 25, 50]$ --- assuming that both \ac{wbc} and \ac{rbc} can be clustered into the same number of virtual cells. I also tested whether blood counts (WBC counts (cells/\Mum), haemoglobin concentration (g/dL) and platelet counts (platelets/\Mum)) improve the classification performance of \ac{mile-vice}. I standardized (mean = 0 and standard deviation = 1) all additional continuous variables --- \ac{wbcc}, haemoglobin concentration or platelet counts. 

From solving these four tasks separately, I can expect the best possible outcome to be four separate models, each of which is trained to solve its task and to identify \ac{vct} which are relevant for the detection of a specific condition. However, I was also interested in the \ac{vct} which are exclusively useful for one task; to this effect, I trained additional models under two specific settings --- one that is a multi-class model, similar to that described in the previous section, and one that focuses on the concurrent optimization of all four tasks using multi-objective learning. Regarding the multi-objective learning setting, in each training step and for each of the four tasks I sampled a set of relevant \ac{wbs} to be considered, predicted the outcome class and calculated the cross-entropy. I then added all four loss values after multiplying them by a vector sampled from a Dirichlet distribution with concentration [1,1,1,1], a trick proposed in \cite{Ruchte2021-ch} to approximate Pareto optimality (i.e. no improvement can be done to one task without making a different task worse \cite{Censor1977-nd}) and backpropagate this value. For this scenario I also tested the inclusion of blood counts and demographic information in the final vector $V$.

To select the best model in each setting I used the cross-validated \ac{auroc}. To get these cross-validated scores, each model is trained over 5 folds and the average value and standard error of each metric is calculated. In each fold, a model is optimized for a maximum 15,000 steps with a learning rate of 0.01 and a weight decay of 0.25. I used a weighted cross-entropy loss and the Adam optimizer \cite{Kingma2014-zd}. The weight for the positive class is calculated as $1 - \frac{\mathrm{no.\ of\ elements\ in\ positive\ class}}{\mathrm{total\ number\ of\ elements}}$. Additionally, the learning rate is decreased every time the training loss stagnates for at least 100 steps by a factor of 0.5. If the learning rate reaches a value of 0.000001 (smaller than the initial learning rate by 4 orders of magnitude) training is stopped. On each training iteration I sample without replacement $500$ \ac{wbc} and $500$ \ac{rbc}. Whenever fewer than $500$ cells were detected, I sample with replacement. This may lead to a situation where bags of cells with a smaller amount of information (fewer cells) contribute equally to those with a large amount of cells. To minimize this, I weigh each instance with a weight $w_{\mathrm{avail}}$ calculated from the number of available \ac{rbc} $m$ and \ac{wbc} $n$ such that $w_{\mathrm{avail}} = 1 + \frac{\mathrm{minimum}(500,m) + \mathrm{minimum}(500,n)}{500*2}$.

Here, I trained \ac{mile-vice} models to perform the same tasks as those in the previous section described above this Chapter ---  disease detection, disease classification, \ac{sf3b1}-mutant \ac{mds} detection and anaemia classification, as well as a multi-objective scenario where the same set of cells is used to optimize different binary tasks. For clarity, I also call the binary class tasks as "single objective" tasks. To reduce the search space for \ac{mile-vice}, I selected the subset of features whose mean or variance had a coefficient with an absolute value greater than 0.01 in the elastic network regression model.

\subsection{MILe-ViCe predicts clinical conditions}

As mentioned above, \ac{mile-vice} has to assume that cells can be clustered into a given number of virtual cells. I tested three different values for the number of virtual cells in the binary classification tasks (10, 25 and 50) and two different values for the multi-objective task (25 and 50). I also tested whether including blood count data can help improve results \figref{fig:mile-vice-performance}. While the number of virtual cells has some impact on the cross-validation \ac{auroc}, I note that model selection is complicated --- particularly, the minimum expected error for the \ac{auroc} in a sample size of 350 is, approximately, 5\%. Nonetheless and for the purpose of downstream analyses, I follow the heuristic of selecting a model based on the best cross-validated \ac{auroc}:

\begin{itemize}
    \item In the \textbf{single objective} setting using \textbf{morphology}, the best performing models are generally the ones with 25 virtual cells excluding the case of anaemia classification, for which the best performing model considers 10 virtual cells;
    \item In the \textbf{single objective} setting using \textbf{morphology and blood counts}, the best performing models have 50 virtual cells excluding the case of anaemia classification, for which the best performance is observed for the model considering 10 virtual cells;
    \item In the \textbf{multiple objective} setting using \textbf{morphology}, the best performing models have 50 virtual cells excluding the case of anaemia classification. In this case, the best performing model considers 25 virtual cells;
    \item In the \textbf{multiple objective} setting using \textbf{morphology and blood counts}, the best performing models have 50 virtual cells excluding the case of disease classification, for which the best performing model has 25 virtual cells.
\end{itemize}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-cv-performance}
    \placecaption{AUROC for MILe-ViCe models with different numbers of virtual cells and using different types of data --- "Morphology" (only using image features retrieved from cells in the slide) and "Morphology + B.C." (using image features from cells and blood counts). The models with the best performance for each set of virtual cell numbers are highlighted with black rectangles.}
    \label{fig:mile-vice-performance}
\end{figure}

While performance does not vary widely between different numbers of virtual cells, this analysis highlights that for some tasks a smaller number of virtual cells is beneficial --- this may be associated with the over-parametrization of models with higher numbers of virtual cells in specific tasks. Additionally, I also note that the multi-objective scenario leads to slightly worse performance (\figref{fig:mile-vice-performance} and \figref{fig:mile-vice-roc-curves}). However, the multi-objective has a clear advantage --- while the single-objective performance can be slightly better, it also offers a less compact representation, with a higher number of possible virtual cells.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-roc-curve}
    \placecaption{AUROC for MILe-ViCe models with different numbers of virtual cells and using different types of data --- "Morphology" (only using image features retrieved from cells in the slide) and "Morphology + B.C." (using image features from cells and blood counts).}
    \label{fig:mile-vice-roc-curves}
\end{figure}

\paragraph{\Ac{mile-vice} outperforms morphometric moment prediction.} Comparing \ac{mile-vice} with the elastic linear regression models trained on morphometric moments shows that \ac{mile-vice} offers better performance (\figref{fig:mile-vice-vs-glmnet} and \figref{fig:mile-vice-vs-glmnet-scatter}) in both the single and multiple objective settings. The only exception is for the task of disease classification, where using \ac{mile-vice} with morphology and blood counts leads to slightly worse performance in both single and multiple objective settings, and using using \ac{mile-vice} with morphology leads to slightly worse performance in the multiple objective setting. Overall, however, I showed here that \ac{mile-vice} offers comparable performance while avoiding aggregating morphometric data in a class-agnostic way. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-vs-glmnet}
    \placecaption{Barplot comparing the cross-validated AUROC between MILe-ViCe and the elastic linear regression model trained on morphometric features (glmnet). Black horizontal lines represent 95\% confidence intervals.}
    \label{fig:mile-vice-vs-glmnet}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-vs-glmnet-scatter}
    \placecaption{Scatterplot comparing the cross-validated AUROC between MILe-ViCe and the elastic linear regression model trained on morphometric features (glmnet).}
    \label{fig:mile-vice-vs-glmnet-scatter}
\end{figure}

\subsection{Virtual cell type association with clinical conditions}

To better understand how the morphological space relates to the \ac{vct} determined by \ac{mile-vice}, I show in \figref{fig:u-map-vc-cells} (top: \ac{wbc}; bottom: \ac{rbc}; the same cells are also shown in \figref{fig:u-map-condition-density}) how different models lead to distinct partitions of this space depending on the task at hand. Interestingly, this makes apparent how the multi-objective model not only defines similar \ac{vct}, but also how it can define novel \ac{vct} which are not considered by other models.

\begin{figure}[!ht]
    \placefigurepng{cytomorphology/u-map-vc-cells}
    \placecaption{Two-dimensional UMAP representation of the morphological space of WBC (top) and RBC (bottom) in grey with virtual cell types centres represented by larger points in different colours for different MILe-ViCe models.}
    \label{fig:u-map-vc-cells}
\end{figure}

Using the virtual cell proportions for each slide, it is also possible to calculate the distance between each \ac{wbs} for each multi-objective task and hierarchically cluster these slides (\figref{fig:heatmap-slides}). This highlights how the characterisation of \ac{wbs} into virtual cell proportions leads to clinically-relevant clustering of \ac{wbs}. Inspecting \ac{wbs} in terms of their virtual cell compositions (\figref{fig:heatmap-slides-vc}) further reveals this and highlights how specific \ac{vct} are more prevalent in specific conditions. Within this cohort --- enriched for disease cases, particularly of \ac{mds}, a disease characterized as having dysplastic myeloid lineage cells --- it is also worthwhile noting that the most prevalent virtual \ac{wbc} type --- WBC26, composed of lymphocytes and immature myeloid lineage cells and shown below in \figref{fig:wbc-mo-examples} --- is relevant mostly to identify disease and \ac{mds} cases, becoming less relevant in comparisons within \ac{mds} cases and cases of anaemia. For \ac{rbc}, on the other hand, the most prevalent virtual \ac{rbc} type is RBC6, composed of relatively large \ac{rbc} --- a hallmark of both megaloblastic anaemia and \ac{mds} --- and shown below in \figref{fig:rbc-mo-examples}. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/heatmap-slides}
    \placecaption{Heatmaps showing the distance between the detected virtual cell proportions in whole blood slides for different tasks in the Morphology + B.C. models. The slides are ordered according to a hierarchical clustering based on the distance matrix and on top of each heatmap I have represented the class to which slide belongs.}
    \label{fig:heatmap-slides}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/heatmap-slides-vc}
    \placecaption{Heatmaps showing the proportions of all virtual cell types (VCT) which are prevalent in at least one slide above 5\% for different tasks. To the right of each heatmap I show the median proportion of each VCT.}
    \label{fig:heatmap-slides-vc}
\end{figure}

These representative analyses highlight an advantage of \ac{mile-vice} over predictions based on morphometric moments --- it is possible to better understand how the prevalence of specific and morphologically well-defined \ac{vct} impacts predictions. Next, I visually inspect these \ac{vct} to construct condition-associated cellular archetypes.

After showing that \ac{mile-vice} is capable of discriminating different clinically relevant conditions, performing always similarly to the elastic network regression model using morphometric moments, and partitioning the multi-dimensional feature space, I inspect specific virtual cell groups to better understand which ones are contributing the most towards classification. To this effect, I retrieve the absolute coefficient values for the classification layer from the best performing \ac{mile-vice} model for each task and multiply it by the cell proportions in the MLLC cohort, thus obtaining an effect-size for each \ac{vct}. I then use this effect size to rank the most and least important \ac{vct}, taking the 5 most important cells for classification (the 5 cells with the highest absolute effect size). The final step is the careful observation of the more important \ac{vct} (the \ac{vct} with the highest effect size) in order to determine how these cell types relate to cytomorphological phenotypes and define cellular (\ac{rbc} and \ac{wbc}) archetypes. I refer here to "morphology-only model" as the models which consider only morphological aspects of cells, and "complete model" as the model which, apart from morphology, also considers \ac{cbc}. 

\subsubsection{Cross-objective importance} 

I started by inspecting the \ac{vct} in the multiple objective models, highlighting that, while some \ac{vct} show up as uniquely discriminative for specific tasks, others are important across distinct tasks (\figref{fig:mile-vice-multi-objective-effects} and \figref{fig:wbc-mo-examples}). More particularly, virtual \ac{wbc} type 39 (mostly composed of monocytes) is more prevalent only in \ac{mds} when compared with anaemias, possibly highlighting a monocytic bias in \ac{mds}. However, virtual \ac{wbc} type 26, featuring both lymphocytes and immature cells, likely of myeloid lineage, is important in both disease detection and disease classification as it is more prevalent in disease, particularly in \ac{mds}. The same applies to, for instance, virtual \ac{wbc} types 1 and 10, featuring large and regular sized hyperlobulated neutrophils and being more prevalent in megaloblastic anaemia and iron deficiency anaemia, respectively. Both cell types are also important in disease detection and for disease detection and \ac{sf3b1}-mutant \ac{mds} detection, respectively. Other such cases, where virtual \ac{wbc} types show up as being important for more than one task, include virtual \ac{wbc} types 47 and 22 featuring regular lymphocytes (relevant for disease classification and \ac{mds}-mutant \ac{mds} detection) and normal neutrophils (relevant for disease detection and \ac{mds}-mutant \ac{mds} detection). 

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-multi-objective-effects}
    \placecaption{Average median effect size for white and red blood cells (WBC and RBC, respectively) in the complete multi-objective model.}
    \label{fig:mile-vice-multi-objective-effects}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/wbc-mo-examples}
    \placecaption{Virtual white and red blood cell (WBC and RBC, respectively) type examples relevant for anaemia classification in the complete multi-objective model.}
    \label{fig:wbc-mo-examples}
\end{figure}

As for virtual \ac{rbc} types I observe a similar scenario --- some cell types are more relevant for specific tasks (i.e. virtual \ac{rbc} type 1, for disease detection), whereas others are relevant across tasks (virtual \ac{rbc} types 17, 50, 24, 45 and 6; \figref{fig:mile-vice-multi-objective-effects} and \figref{fig:rbc-mo-examples}). Particularly, small poikilocytic \ac{rbc} (irregularly shaped; virtual \ac{rbc} type 24) are more prevalent in non-\ac{sf3b1}-mutant \ac{mds} (vs. \ac{sf3b1}-mutant \ac{mds}), iron deficiency anaemia (vs. megaloblastic anaemia) and in \ac{mds} (vs. with anaemia) and large \ac{rbc} are more present in anaemia (vs. \ac{mds}), \ac{sf3b1}-mutant \ac{mds} (vs. non-\ac{sf3b1}-mutant \ac{mds}) and megaloblastic anaemia (vs. iron deficiency anaemia), revealing fairly opposite trends. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/rbc-mo-examples}
    \placecaption{Virtual white and red blood cell (WBC and RBC, respectively) type examples relevant for anaemia classification in the complete multi-objective model.}
    \label{fig:rbc-mo-examples}
\end{figure}

This multi-objective model enables the detection of \ac{vct} which are important across tasks. However, as it is also possible to focus on single-objective models not only to confirm some \ac{vct} specified above but also to reveal novel and more nuanced virtual \ac{wbc} types.

\subsubsection{Disease detection} 

In disease detection (normal vs. disease), it is evident that \ac{mile-vice} does a good job at descriminating between cell types which are more prevalent in each condition when using only morphology and when using both morphology and \ac{cbc} (B.C.; \figref{fig:mile-vice-vcq-so-disease-detection}). More particularly, when considering \ac{rbc}, relatively large \ac{rbc} (high perimeter) are one of the \ac{rbc} archetypes detected by \ac{mile-vice} as more prevalent in disease when compared with normal cases (virtual \ac{rbc} types 25, 42 and 5 in the morphology-only model and 44, 16, 35 and 19 in the complete model; \figref{fig:rbc-disease-detection-examples}). Additionally, rounder \ac{rbc} (low eccentricity) are \ac{rbc} archetypes of the normal classification (virtual \ac{rbc} types 45 in the morphology-on ly model and 37 in the complete model \figref{fig:rbc-disease-detection-examples}). However, it should be noted that \ac{rbc} homogeneity makes it complicated to assign specific and well-defined \ac{rbc} archetypes. These \ac{rbc} archetypes make sense --- a hallmark of \ac{mds} and megaloblastic anaemia is indeed enlarged \ac{rbc}, while the presence of non-circular \ac{rbc} (poikilocytosis) is a general hallmark of aberrant \ac{rbc} production as observed in both \ac{mds} and anaemia \cite{Ford2013-nd}. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-vcq-so-disease-detection}
    \placecaption{The effect size and average proportion ratio for the five most relevant virtual cell types for both red blood cells (RBC) and white blood cells (WBC) for disease detection (disease vs. normal) when using only morphological features (Morphology) and when using both morphological features and complete blood counts (Morphology + B.C.). Positive effect values/higher proportion ratio are associated with normal cases (controls), whereas negative effect values/lower proportion ratio are associated with disease cases.}
    \label{fig:mile-vice-vcq-so-disease-detection}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/rbc-disease-detection-examples}
    \placecaption{Virtual red blood cell (RBC) type examples relevant for disease detection for the morphology-only model and the complete model.}
    \label{fig:rbc-disease-detection-examples}
\end{figure}

A relevant \ac{wbc} archetype can also be pointed out (\figref{fig:mile-vice-vcq-so-disease-detection}) --- virtual \ac{wbc} type 20 in the morphology-only model and 4 in the complete model contain neutrophils featuring nuclear abnormalities (pseudo-Pelger-Hut anomalies/band cells, characterized by either U- or dumbbell-shaped nuclei \cite{Bain2005-zg} and nuclear hyperlobulation), whereas \ac{vct} features, among other types of cells, a relatively high proportion of blasts \figref{fig:wbc-disease-detection-examples}. It is worth highlighting that, specifically for this task, the identified \ac{wbc} archetypes are somewhat varied, probably due to the considerable variability of \ac{wbc} in anaemias and, more particularly, in \ac{mds} \cite{Bain2005-zg,Bain2014-oc}. I must note here that distinguishing between some specific \ac{wbc} can be complicated --- particularly, band cells (immature and hypolobulated neutrophils, typically with U-shaped nuclei) and pseudo-Pelger-Hut anomalies (granulocytes with U- or dumbbell-shaped nuclei) are remarkably similar and their distinction is non-trivial --- as mentioned, both can be loosely characterized as granulocytes with U-shaped nuclei, with band cells having slightly larger nuclei and less densely packed chromatin (i.e. the staining appears lighter under the microscope) \cite{Colella2012-so}. These fine-grained differences are likely to go undifferentiated within \ac{mile-vice} in the task of discriminating \ac{mds} and anaemia, particularly since both cell types have been observed in cases of \ac{mds} \cite{Davey1988-zn,Cunningham1995-pc}.

\begin{figure}[!ht]
    \placefigure{cytomorphology/wbc-disease-detection-examples}
    \placecaption{Virtual white blood cell (WBC) type examples relevant for disease detection for the morphology-only model and the complete model. Examples of hyperlobulated neutrophils and pseudo-Pelger-Hut anomalies/band cells are circled in red and green, respectively.}
    \label{fig:wbc-disease-detection-examples}
\end{figure}

Henceforth, I focus on the \ac{vct} important for the classification while using \ac{cbc} --- this allows me to focus on aspects of condition prediction which are not captured by \ac{cbc} as these are relatively simple to obtain. 

\subsubsection{Disease classification} 

In disease classification (anaemia vs. \ac{mds}), an \ac{rbc} archetype typical of anaemia is the presence of dacrocytes (tear-shaped \ac{rbc}) and eliptocytes (elongated \ac{rbc}; 25 in the complete model), whereas larger \ac{rbc} are expected in \ac{mds} (15 and 23 in the complete model; \figref{fig:mile-vice-vcq-so-disease-classification} and \figref{fig:rbc-disease-classification-examples}). Regarding \ac{wbc} archetypes, the presence of normal lymphocytes is more prevalent in anaemia (18 in the complete model), whereas pseudo-Pelger-Hut anomalies/band cells and immature myeloid lineage \ac{wbc} (blasts) are more typical of \ac{mds} (9 and 24 in complete model; \figref{fig:wbc-disease-classification-examples}). Here it is important to highlight the fact that blasts are not a group of cells defined by a single set of characteristics --- indeed, a blast can any of the following: a deformable nucleus (in contrast with lymphocytes, were the nuclei are generally round), immature chromatin (textural variation within the nuclei), a relatively small cytoplasm-to-nucleus ratio and relatively large sizes (typically larger than lymphocytes) \cite{Bain2004-uq,Bain2005-zg,Bain2014-oc}.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-vcq-so-disease-classification}
    \placecaption{The effect size and average proportion ratio for the five most relevant virtual cell types for both red blood cells (RBC) and white blood cells (WBC) for disease classification (anaemia vs. myelodyspolastic syndrome (MDS)) when using only morphological features (Morphology) and when using both morphological features and complete blood counts (Morphology + B.C.). Positive effect values/higher proportion ratio are associated with MDS cases, whereas negative effect values/lower proportion ratio are associated with anaemia cases.}
    \label{fig:mile-vice-vcq-so-disease-classification}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/rbc-disease-classification-examples}
    \placecaption{Virtual red blood cell (RBC) type examples relevant for disease classification for the complete model.}
    \label{fig:rbc-disease-classification-examples}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/wbc-disease-classification-examples}
    \placecaption{Virtual white blood cell (WBC) type examples relevant for disease classification for the complete model. Examples of pseudo-Pelger-Hut anomalies/band cells and immature myeloid lineage cells are circled in green and blue, respectively.}
    \label{fig:wbc-disease-classification-examples}
\end{figure}

\subsubsection{\ac{sf3b1}-mutation detection} 

The task of \ac{sf3b1}-mutation detection focuses on detecting which individuals with \ac{mds} have an \ac{sf3b1} mutation. \Ac{sf3b1} mutations are generally recognized as having a better prognosis and a fairly well determined cytomorphological phenotype in the bone marrow \cite{Malcovati2020-no,Hellstrom_Lindberg2015-zs,Malcovati2015-tz}. To the best of my knowledge, no cytomorphogical phenotype has been previously identified for \ac{sf3b1}-mutant \ac{mds} --- here I outline such a phenotype. 

Using \ac{mile-vice}, it is possible to detect both \ac{rbc} and \ac{wbc} archetypes in \ac{sf3b1}-mutant \ac{mds} (\figref{fig:mile-vice-vcq-so-disease-classification}) --- the most easily identifiable \ac{rbc} archetype is relatively large \ac{rbc}, which are more prevalent in \ac{sf3b1}-mutant \ac{mds}, while poikilocytic \ac{rbc} are more prevalent in other \ac{mds} subtypes (15 and 2 in the complete model; \figref{fig:rbc-mds-classification-examples}). As for \ac{wbc}, the prevalence of pseudo-Pelger-Hut anomalies is higher in cases of \ac{sf3b1}-mutant \ac{mds} (\ac{vct} 2 in the complete model \figref{fig:wbc-mds-classification-examples}). These are unlikely to be band cells due to the lack of granules in the cytoplasm, a hallmark of pseudo-Pelger-Hut anomalies.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-vcq-so-mds-classification}
    \placecaption{The effect size and average proportion ratio for the five most relevant virtual cell types for both red blood cells (RBC) and white blood cells (WBC) for myelodysplastic syndrome (MDS) classification (\textit{SF3B1}-mutant vs. non-\textit{SF3B1}-mutant MDS) when using only morphological features (Morphology) and when using both morphological features and complete blood counts (Morphology + B.C.). Positive effect values/higher proportion ratio are associated with non-\textit{SF3B1}-mutant MDS cases, whereas negative effect values/lower proportion ratio are associated with \textit{SF3B1}-mutant MDS cases.}
    \label{fig:mile-vice-vcq-so-mds-classification}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/rbc-mds-classification-examples}
    \placecaption{Virtual red blood cell (RBC) type examples relevant for myelodysplastic syndrome (MDS) classification for the complete model.}
    \label{fig:rbc-mds-classification-examples}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/wbc-mds-classification-examples}
    \placecaption{Virtual white blood cell (WBC) type examples relevant for myelodysplastic syndrome classification for the complete model. Examples of pseudo-Pelger-Hut anomalies/band cells are circled in green.}
    \label{fig:wbc-mds-classification-examples}
\end{figure}

\subsubsection{Anaemia classification} 

The final task I used to evaluate the performance of \ac{mile-vice} was that of anaemia classification (iron deficiency vs. megaloblastic anaemia). Here, the \ac{rbc} archetypes are relatively simple as they all capture the expected aspects of both of these anaemias --- iron deficiency anaemias exhibit \ac{rbc} which are smaller, whereas \ac{rbc} in megaloblastic anaemia are considerably larger (virtual \ac{rbc} types 4/23 and 19, respectively, in the complete model; \figref{fig:rbc-anaemia-classification-examples}) and there is a larger fraction of poikilocytic \ac{rbc} in megaloblastic anaemia (virtual \ac{rbc} type 23; \figref{fig:rbc-anaemia-classification-examples}). As for \ac{wbc}, \ac{mile-vice} captures a fairly well known \ac{wbc} archetype in both megaloblastic anaemia and iron deficiency anemia --- hyperlobulated neutrophils (virtual \ac{wbc} type 14 and 12, respectively, in the complete model; \figref{fig:wbc-anaemia-classification-examples}) \cite{Lindenbaum1980-ux,Westerman1999-gs}. The main difference between both of these groups is that in megaloblastic anaemia hyperlobulated neutrophils (\ac{vct} 14) are considerably larger than in iron deficiency (\ac{vct} 12). While being a hallmark of both iron deficiency and megaloblastic anaemia, hyperlobulated neutrophils are larger in megaloblastic anaemia.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-vcq-so-anaemia-classification}
    \placecaption{The effect size and average proportion ratio for the five most relevant virtual cell types for both red blood cells (RBC) and white blood cells (WBC) for anaemia classification (iron deficiency vs. megaloblastic anaemia) when using only morphological features (Morphology) and when using both morphological features and complete blood counts (Morphology + B.C.). Positive effect values/higher proportion ratio are associated with iron deficiency anaemia cases, whereas negative effect values/lower proportion ratio are associated with megaloblastic anaemia cases.}
    \label{fig:mile-vice-vcq-so-anaemia-classification}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/rbc-anaemia-classification-examples}
    \placecaption{Virtual red blood cell (RBC) type examples relevant for anaemia classification for the complete model.}
    \label{fig:rbc-anaemia-classification-examples}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/wbc-anaemia-classification-examples}
    \placecaption{Virtual white blood cell (WBC) type examples relevant for anaemia classification for the complete model. Examples of pseudo-Pelger-Hut anomalies/band cells are circled in green.}
    \label{fig:wbc-anaemia-classification-examples}
\end{figure}

\subsection{Expert annotation}

Three haematologists annotated 1746 \ac{rbc} and 1600 \ac{wbc} automatically detected in MLLC using the protocol described in Chapter 4 to assess whether each \ac{vct} were enriched in any expert-annotated blood cell type. For the annotation, I implemented an online platform --- \ac{tbca} --- where haematologists could register and annotate cells according to previously defined cell types discussed with my co-advisor George Vassiliou. More particularly, \ac{wbc} could be classified as neutrophils, basophils, eosinophils, band cells, lymphocytes, monocytes, blasts or artefacts (poor resolution, nucleated \ac{rbc}, reticulocytes, fragmented or dead \ac{wbc}, multiple \ac{wbc}, incomplete or no \ac{wbc} and platelet clumps). \Ac{rbc} could be classified as normal \ac{rbc}, nucleated \ac{rbc}, spherocytes, target cells, irregularly contracted, dacrocytes, keratocytes, echinocytes, eliptocytes, acanthocytes and artefacts (poor resolution, multiple \ac{rbc}, incomplete or no \ac{rbc} and platelet clumps, platelets or cases where platelets were segmented jointly with \ac{rbc}). Whenever a cell had more than one annotation, I used a majority rule to decide which annotation to keep. To address ties, I selected a label at random.

The Blood Cell Atlas --- was deployed in the \ac{ebi} Embassy cloud using Kubernetes, with a backend in Flask, Python and PostGreSQL and a frontend with Flask and Bootstrap. In \ac{tbca}, each \ac{wbc} and \ac{rbc} is labelled using a dropdown menu by experts (\figref{fig:tbca}; available in \url{http://45.88.80.93:5000/}).

\begin{figure}[!ht]
    \placefigure{cytomorphology/tbca-screenshot}
    \placecaption{Screenshot of \ac{wbc} annotation menu in The Blood Cell Atlas. Each cell can be individually labelled with a \ac{wbc} type. Each user has to create an account to access the information in \ac{tbca} and the user base of expert haematologists from Addenbrooke's Hospital was curated and aproved by me and George Vassiliou.}
    \label{fig:tbca}
\end{figure}

\paragraph{Concordance is limited between experts.} I started this analysis by noting that most annotations were done by a single expert which can be problematic as shown by previous studies \cite{De_Swart2017-wc,Howe2004-mn,Goasguen2009-dn,Foucar2020-uz}. This is further highlighted once I take a more dedicated look at the degree of agreeability between experts --- in \figref{fig:mile-vice-annotated-cells-wbc-concordance} I show, for cells which were annotated by two or more experts, the fraction of annotations with at least one disagreement. In essence, while some cell groups (neutrophils or lymphocytes) show good concordance, others are more subjective --- annotations of monocytes and band cells/Pelger-Hut anomalies by experts show very limited agreeability between experts. Taking this into account during this analysis is crucial as it renders some annotations (particularly those of monocytes and Pelger-Hut anomalies) considerably more questionable. Analysis of which annotations are picked by experts stratified by the majority label shows that Pelger-Hut anomalies were considered neutrophils in at least one third of the annotations (22/65), in line with previous reports showing that the annotation of nuclear hypolobulation in neutrophils --- where neutrophils have two or fewer nuclear lobules --- showed the least inter-expert agreement \cite{Weinberg2015-ra}. Monocytes are considered neutrophils or lymphocytes in 20.6\% and 7.6\% of the annotations, respectively. I also note here that the "poor resolution" and the "fragmented/unrecognizable" categories also have a relatively high fraction of uncertainty. This may be due to the personal experience of each expert --- while some experts will be more confident in calling specific cell types, others will be more confident in not analysing ambiguous cell types since the diagnostic is generally performed by inspecting a sufficiently large number of peripheral blood cells. Very few \ac{rbc} were annotated by more than one expert (N=28) and, as such, no assessment of inter-expert agreement will be performed.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-annotated-cells-wbc-concordance}
    \placecaption{Proportion of white blood cell type annotations where all experts agree. Black horizontal lines represent 95\% confidence intervals.}
    \label{fig:mile-vice-annotated-cells-wbc-concordance}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-annotated-cells-wbc-concordance-heatmap}
    \placecaption{Distribution of annotations stratified by the majority label (the most consensual label).}
    \label{fig:mile-vice-annotated-cells-wbc-concordance-heatmap}
\end{figure}

\paragraph{An excess of blasts and Pelger-Hut/band cells are identified in the blood of healthy individuals by experts.} To further understand whether these labels could be used reliably, I assessed whether annotated \ac{wbc} typically associated with pathogenic clinical conditions --- Perger-Hut/band cells and blasts --- were less prevalent in normal individuals. There appears to be no statistically significant differences between either cell type and clinical conditions, with the exception of an overrepresentation of Perger-Hut/band cells in \ac{mds} when compared with anaemia ($p = 0.027$ for a Poisson rate ratio test; \figref{fig:annotated-wbc-rate} and \figref{fig:annotated-wbc-rate-test}). It is worth noting that, unlike blasts, band cells can be common in healthy individuals (up to 10\% of the total granulocyte count \cite{Drees2012-sz}). However, Pelger-Hut anomalies are considerably more common in \ac{mds} than in normal individuals \cite{Kuriyama1986-ts,Colella2012-so} and the reported rates of congenital Pelger-Hut anomalies are too low to explain the similar prevalence of these cell types between healthy individuals and individuals with \ac{mds} (1 in 6,000 in the United Kingdom) \cite{Colella2012-so}. Finally, it is unreasonable to expect blasts to be equally prevalent in both healthy individuals and individuals with \ac{mds} --- while \ac{mds} features a relatively lower amount of blasts when compared with \ac{aml}, healthy individuals should present no blasts in peripheral blood \cite{Aster2020-cu}.

\begin{figure}[!ht]
    \placefigure{cytomorphology/annotated-wbc-rate}
    \placecaption{Detection rates for white blood cell types stratified by condition.}
    \label{fig:annotated-wbc-rate}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/annotated-wbc-rate-test}
    \placecaption{Poisson rate ratio tests between different conditions for expert annotations for Pelger-Hut/band cells and blasts.}
    \label{fig:annotated-wbc-rate-test}
\end{figure}

\paragraph{Expert-annotated \ac{wbc} types are enriched in specific \ac{vct}.} While expert annotation may not be agreeable or feasible in some cases, it is worth highlighting that, without explicitly training \ac{mile-vice} to do so, it implicitly defines virtual \ac{wbc} types which are enriched for expert-annotated \ac{wbc} types (\figref{fig:mile-vice-annotated-cells-wbc}). This appears to be the clearest in the disease detection task, where there is at least one virtual \ac{wbc} enriched for all annotated \ac{wbc} types excluding blasts. The tasks where \ac{mile-vice} implicitly defined blast-enriched virtual \ac{wbc} types are those of disease classification (virtual \ac{wbc} type 24, also visible in \figref{fig:wbc-disease-classification-examples}). Additionally, \ac{wbc} type 9 in the disease classification task and virtual \ac{wbc} type 2, enriched in Perger-Hut anomalies/band cells, were also discussed above and displayed in \figref{fig:wbc-disease-classification-examples} and \figref{fig:wbc-mds-classification-examples}. In anaemia classification, virtual \ac{wbc} type 12 was identified as being enriched by neutrophils and is also more prevalent in iron deficiency, characterized by small/regular-sized and hyperlobulated neutrophils \figref{fig:wbc-anaemia-classification-examples}. In this task, I also observe the unlikely enrichment of blasts in two virtual \ac{wbc} groups, co-occurring in the same virtual \ac{wbc} types as monocytes and lymphocytes, respectively. This further highlights what has been noted above regarding the agreeability of the blast-annotation between experts. In \ac{rbc}, on the other hand, there is little evidence of virtual \ac{rbc} types capturing specific \ac{rbc} types except acanthocytes (irregularly-shaped \ac{rbc}) in disease detection and dacrocytes in \ac{sf3b1}-mutant \ac{mds} detection. However, it is worth noting that very few examples of any \ac{rbc} excluding normal \ac{rbc} and spherocytes have been annotated, preventing a more accurate estimation of these co-occurrence effects.

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-annotated-cells-wbc}
    \placecaption{Proportion of annotated white blood cell (WBC) types in each virtual cell types (VCT; left) and number of annotated WBC (right). Only VCT with at least 10\% of a specific WBC type are shown. Positive and statistically significant enrichments according to a Fisher's test are annotated with a "*".}
    \label{fig:mile-vice-annotated-cells-wbc}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-annotated-cells-rbc}
    \placecaption{Proportion of annotated red blood cell (RBC) types in each virtual cell type (VCT; left) and number of annotated RBC (right). Only VCT with at least 10\% of a specific RBC type are shown. Positive and statistically significant enrichments according to a Fisher's test are annotated with a "*".}
    \label{fig:mile-vice-annotated-cells-rbc}
\end{figure}

\section{External validation of models}

I used AC2, a cohort of individuals with either one of the conditions studied above in this chapter --- case controls (normal; N=10), iron deficiency anaemia (N=12), megaloblastic anaemia (N=3), \ac{sf3b1}-mutant \ac{mds} (N=13) and other \ac{mds} subtypes (specifically, \ac{srsf2}-mutant \ac{mds}; N=12). 

For the elastic regression model it is possible to state that there is a good generalization capability, with \ac{auroc} scores suffering no significant drop in the external validation cohort (\figref{fig:glmnet-auc-validation}). However, when inspecting the same scores for \ac{mile-vice} trained only on cell morphology, a considerable drop in \ac{auroc} for the disease detection task is evident (\figref{fig:glmnet-auc-validation}), which led me to further investigate possible reasons for this drop.

\begin{figure}[!ht]
    \placefigure{cytomorphology/glmnet-auc-validation}
    \placecaption{Cross-validated (bars) and external validation AUROC values (diamonds) for the elastic net regression model. The confidence intervals for the external validation are represented as black lines.}
    \label{fig:glmnet-auc-validation}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-auc-validation}
    \placecaption{Cross-validated (bars) and external validation AUROC values (diamonds) for MILe-ViCe. The confidence intervals for the external validation are represented as black lines.}
    \label{fig:mile-vice-auc-validation}
\end{figure}

To investigate why this drop in performance happens for disease detection using only morphology, I inspected the virtual \ac{wbc} types where there was a considerable shift in the median proportion between datasets (\figref{fig:disease-detection-vcq-comparison}). Three virtual \ac{wbc} types are different by more than 10\% --- 23, 15 and 47. Virtual \ac{wbc} types 23 (much more prevalent in normal individuals from AC2) and 15 (much more prevalent in normal individuals in MLLC) capture actual morphometric characteristics of cells which are likely to be differently distributed between cohorts --- Pelger-Hut anomalies/band cells and \ac{wbc} with a higher eccentricity (less round) or higher mass displacement (colour distribution shifted from the centre), respectively. However, virtual \ac{wbc} type 47 captures, in MLLC, artefacts and has very low prevalence in this cohort. However, in AC2, this prevalence is significantly increased, particularly in \ac{wbs} of individuals with a disease --- this is likely due to both scanners having distinct resolutions, which may lead to different estimates of texture attributes.

\begin{figure}[!ht]
    \placefigure{cytomorphology/disease-detection-vcq-comparison}
    \placecaption{Comparison of the distribution of virtual white blood cells (VWBC) in training and validation data (MLLC and AC2 cohorts, respectively). In the top left corner is the graph showing how VWBC are distributed between both cohorts, with each point representing the median distribution for that cohort and horizontal/vertical lines representing the 90\% interval for the training and validation data, respectively. On the top right and bottom left and right corners are examples of the cells from the VWBC where the difference between both distributions was larger than 10\%.}
    \label{fig:disease-detection-vcq-comparison}
\end{figure}

Having done this, I further inspect the possible differences between datasets --- by reducing the morphometric moments to a two-dimensional space using a \ac{umap} and inspecting their distribution, a batch effect becomes considerably evident and relatively more apparent for \ac{rbc} when compared with \ac{wbc} (\figref{fig:u-map}). Both of these analyses highlight a problem of trying to generalize \ac{ml} algorithms trained on single-centre datasets --- often times one observes dataset shift. 

\begin{figure}[!ht]
    \placefigure{cytomorphology/u-map}
    \placecaption{Uniform manifold approximation and projection (UMAP) for the morphometric moments stratified by datasets for white blood cell features (left), red blood cell features (center) and for the features of both cell types combined (right). UMAP1/2 refer to the two dimensions of the UMAP projection.}
    \label{fig:u-map}
\end{figure}

\subsection{Dataset shift} 

In \ac{ml}, the objective is to estimate the joint probability of the predictors $X$ and the labels $Y$, ($P(X,Y)=P(Y|X)P(X)$). However, the learning algorithm does not have access to $P(X)$, only to the probability of the training data $X_{train}$, $P(X_{train})$. Consequently, if the distribution of the validation data, $P(X_{val}$, of the relationship between the validation data and the validation labels, $P(Y|X_{val})$, shifts, the joint probability will also change. This is known as a dataset shift and can be further classified into \textit{covariate} shift, where $P(X_{val})$ is shifted, or \textit{concept} shift, where $P(Y|X_{val})$ is shifted \cite{Y2019-vc}. The fact that the feature distributions are considerably different between datasets (\figref{fig:u-map}) hints that this may be a covariate shift, where the feature extraction protocol produces different results between datasets.

\subsubsection{Experimental causes for dataset shift} 

Firstly, I considered in which ways the external validation cohort (AC2) differed from the training cohort (MLLC) --- AC2, while similar in composition to (MLLC), was digitalized using a different scanner --- an Aperio AT2 --- and slides were obtained in different ways depending on whether they were from an \ac{mds} patient. Whereas slides from normal individuals or individuals with anaemia were digitalized within 12 hours after being automatically smeared and stained using a Siemens Hematek 3000 system, the slides from individuals with \ac{mds} came from a different laboratory, dedicated to haematooncological diagnostic, and were prepared (smeared and stained) by hand 12-24 hours after blood collection. This difference in preparation time induces different levels of \ac{edta} artefacts --- as mentioned in the Introduction, \ac{edta} is an anticoagulant agent used to ensure that there is no cellular aggregates in the \ac{wbs}; however, if more than a few hours pass between the addition of \ac{edta} to blood and the smearing, artefacts affecting both \ac{wbc} and \ac{rbc} are to be expected even after 2 hours, with their severity and frequency increasing as time passes \cite{Bain2005-zg,Narasimha2008-fh}.

Furthermore, the Aperio AT2, as mentioned earlier in this Chapter, has a slightly different resolution from the Hamamatsu Nanozoomer 2.0 which was used to digitalize the other cohorts (0.2517 micrometers/pixel for Hamamatsu NanoZoomer 2.0; 0.2268 micrometers/pixel for Aperio AT2) and to correct this systematic shift I resize images digitalized using the Aperio AT2 prior to their analysis; however, this resizing step may introduce interpolation artefacts which can cause small changes to the values of each shape descriptor. Other artefacts, relating to differences in image compression and digitalization associated with the use of difference scanners, may also influence this.

\subsubsection{Unbiased feature selection} 

Typical solutions to training a \ac{ml} algorithm that is resistant to dataset shift always rely on either having multiple sources for the data (i.e. multi-centre datasets) and allowing the algorithm to control for sources of noise associated with different datasets or in the estimation of the importance of each sample based on the empirical or estimated density of this sample in the validation dataset \cite{Y2019-vc}. In other words, the solutions for dataset shift implicate having access to more data, be it data coming from other sources or the actual validation data.

As a demonstration of the potential of this feature extraction protocol, I have excluded features which were predictive of each dataset --- either MLLC or AC2. To do this, I used the Mann-Whitney U-statistic between both datasets for all features and divide it by the product of both sample sizes, a measure known as the common language effect size which is equivalent to the \ac{auroc}. The common language effect size represents the proportion of pairs supporting a direction --- values close to 0 or 1 imply that the U-statistic is biased in a specific direction (towards a specific dataset in my case), whereas values close to 0.5 imply little biasing \cite{Kerby2014-fy}. Setting a hard cut-off for the common language effect size between $1/3$ and $2/3$ (\figref{fig:auc-discarded}), I regenerate the \ac{umap} representations, confirming that there no longer appears to be a visible separation between datasets \figref{fig:u-map-unbiased}. Having confirmed this, I retrain both the elastic regression model and \ac{mile-vice} using only these unbiased features (20 \ac{wbc} features and 18 \ac{rbc} features). I note here that the point of this analysis is not to prove generalization, but rather to demonstrate the task-specific utility of the methodology here presented when the training protocol enables the elimination of dataset-specific noise.

\begin{figure}[!ht]
    \placefigure{cytomorphology/auc-discarded}
    \placecaption{AUROC values for dataset prediction for all morphometric moments in each cell type and the boundaries ($1/3$ to $2/3$) used to classify a feature as predictive or not (left) and the fraction of features kept (right).}
    \label{fig:auc-discarded}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/u-map-unbiased}
    \placecaption{Uniform manifold approximation and projection (UMAP) for the morphometric moments stratified by datasets for white blood cell unbiased features (left), red blood cell unbiased features (center) and for the unbiased features of both cell types combined (right). UMAP1/2 refer to the two dimensions of the UMAP projection.}
    \label{fig:u-map-unbiased}
\end{figure}

Excluding features which were considerably different between datasets comes at the cost of a considerable drop in performance for the \ac{sf3b1}-mutant \ac{mds} detection task when considering the elastic net regression model, whereas other \ac{auroc} scores remained relatively similar (\figref{fig:glmnet-auc-validation-unbiased}). On the other hand, while using an dataset-unbiased set of features, \ac{mile-vice} consistently retains its predictive ability except for the task of disease classification using only morphological data, where it dramatically underperforms (\figref{fig:mile-vice-auc-validation-unbiased}). Both cases are likely to stem from underfitting, where the morphological description is not rich enough to enable the model to learn to discriminate between conditions. In any case, I show that it is possible to partially address the fact that features are differently distributed between cohorts.

\begin{figure}[!ht]
    \placefigure{cytomorphology/glmnet-auc-validation-unbiased}
    \placecaption{Cross-validated (bars) and external validation AUROC values (diamonds) for the elastic net regression model using only dataset-unbiased features. The confidence intervals are represented as horizontal black lines.}
    \label{fig:glmnet-auc-validation-unbiased}
\end{figure}

\begin{figure}[!ht]
    \placefigure{cytomorphology/mile-vice-auc-validation-unbiased}
    \placecaption{Cross-validated (bars) and external validation AUROC values (diamonds) for MILe-ViCe using only dataset-unbiased features. The confidence intervals are represented as horizontal black lines.}
    \label{fig:mile-vice-auc-validation-unbiased}
\end{figure}

\FloatBarrier

\section{Discussion}

In this chapter I used one \ac{wbs} cohort --- MLLC --- to show how the protocol outlined in Chapter 4 can be used to create individual and clinically-relevant cytomorphological profiles based on morphometric moments, applying them successfully to the prediction of different haematological conditions. Additionally, using vocabulary-based \ac{mil}, a \ac{ml} paradigm focused on the discovery of latent terms which are relevant for the classification of bags of instances, can be used to partition the cytomorphology space into clinically-relevant virtual cells types, which can be used as cytomorphological hallmarks --- cellular archetypes --- of different haematological conditions while performing adequately in most predictive tasks.

\paragraph{Computational cytomorphology enables the prediction of clinically-relevant conditions and identification of cellular archetypes.} In this Chapter, I show how the multi-dimensional morphometric space of blood cells is relatively continuous, with specific morphologies enriched in specific conditions. Computational cytomorphology can be used to accurately predict different clinical conditions using only \ac{wbs} and \ac{cbc}, noting that this generalizes to other datasets except when considering the task of disease detection using \ac{mile-vice}. I uncover specific cellular subtypes associated with each condition, showing how weak supervision in a \ac{mil} setting can be used to derive powerful conclusions regarding the specific cytomorphological signatures which characterize each condition. 

The relative prevalence of these cellular archetypes across different conditions was used to verify some previously stated conclusions such as the prevalence of hyperlobulated in both iron deficiency and megaloblastic anaemia \cite{Lindenbaum1980-ux,Westerman1999-gs} and the relatively large \ac{rbc} sizes in megaloblastic anaemia when compared with iron deficiency anaemia, both of which were observed in the single and multiple objective models, and the presence of Pelger-Hut cells in \ac{mds} \cite{Colella2012-so}. Additionally, \ac{mile-vice} uncovers novel associations between cellular archetypes and specific conditions --- Perger-Hut anomalies are more common in \ac{sf3b1}-mutant \ac{mds} than in other \ac{mds} subtypes (detected in the single objective model) and, while hyperlobulated neutrophils are present in both iron deficiency anaemia and megaloblastic anaemia, those in the latter are typically larger (detected in both single and multiple objective models). This suggests that the increase in cellular size observed in \ac{rbc} in megaloblastic anaemia also affects granulocytes. A further novel cellular archetype detected by both the elastic network regression and \ac{mile-vice} is the increase in \ac{rbc} size in \ac{sf3b1}-mutant \ac{mds} when compared with other \ac{mds} subtypes (detected in both single and multiple objective models). The main objective of these cellular archetypes is to provide haematologists with novel types of cell that can allow them to better discriminate between conditions; considering this, the validation of cellular archetypes as valuable clinical tools will have to be done by providing them as guidelines for trained experts and determining whether they provide relevant information for condition discrimination.

\paragraph{Neutrophil lobulation.} Considering the biology of these tasks, little is known about the mechanisms which lead to alterations to blood cell maturation such as the ones described above. It is thought that neutrophil hyperlobulation can be caused by nutrient deficiency (as would be the case of megaloblastic anaemia, typically caused by folate or vitamin B12 deficiency) or iron deficiency anaemia but no known functional role has been identified thus far \cite{Manley2018-xo}. Hypolobulation, on the other hand, can be relatively normal if observed in band cells small proportions or benign if associated with congenital Pelger-Hut anomaly \cite{Colella2012-so}, but in sufficiently high numbers can be indicative of deficient cell maturation \cite{Aster2020-cu}. To further complicate these reflections, the literature shows no good agreement regarding the actual function of nuclear lobulation, with possible differences between the functional impacts of inherited and acquired conditions \cite{Manley2018-xo}. Similarly, enlarged \ac{rbc} can also be caused, as mentioned, by nutrient deficiency and \ac{mds} \cite{Aslinia2006-en}, but have no specific functional impact. 

\paragraph{Towards generalization.} External validation shows this methodology has good generalization capabilities across all tasks when tested in data from a different centre except in a single case --- for \ac{mile-vice}, the detection of diseases (\ac{mds} or anaemia vs. healthy controls) shows notably poorer predictive performance when tested on an independent test set, an effect that is likely to stem from dataset shift --- a change in the probability distribution of the data. This highlights an important aspect of works in digital histopathology which has been stated in recent reviews --- large multi-centre training sets, allowing \ac{ml} algorithms to learn how to control for dataset origin (which can affect, among other aspects, image compression, illumination, and stain intensity and distribution), are an increasing necessity if good generalization is to be expected \cite{Van_der_Laak2021-id}, especially in settings where images are obtained mainly for clinical, rather than scientific, use. Additionally, using large multi-centre and multi-digitaliser training sets would enable the training of deep-learning methods to characterize the morphology of both \ac{wbc} and \ac{rbc} and ensure that they control for sources of variation associated with specific centres and digitalisers. 

\section{Limitations and future directions}

Apart from the issues described above regarding generalization and performance on an external validation cohort, it is worth highlighting how other factors influence the applicability of the methods outlined here and how they can be overcome.

\paragraph{Inter-individual variation.} While I show the potential of computational cytomorphology to determine novel cellular archetypes and predict clinical conditions, it is nonetheless worth highlighting that alterations to blood morphology can be caused by a myriad of factors, including genetics, age, sex, or ethnicity \cite{Bain2014-oc,Hellstrom_Lindberg2015-zs,Lorey1996-yc}. Controlling for these factors in computational cytomorphology frameworks such as the ones developed in this Chapter may lead to more robust and reliable associations between clinical conditions and cellular archetypes systematically.

\paragraph{Technical variation.} As discussed above, \ac{wbs} scanning, preparation and staining, can have a sizeable impact on cellular morphology. The implementation of standards is not novel in \ac{wbs} preparation and staining \cite{Vives_Corrons2004-ha}, but it should be highlighted that registering sources of technical variability --- the amount of time between blood being drawn and \ac{wbs} preparation and method of preparation, for example --- can greatly help in reducing the impact these artefacts can have on the determination of cellular archetypes. Additionally, the determination of the cytomorphological hallmarks of different artefacts --- such as those cause by \ac{edta} or other anticoagulants --- could be robustly assessed using a cohort of digitalized slides prepared at increasing lengths of time after mixing with \ac{edta}. This would not only reveal how \ac{edta} affects blood cytomorphology systematically, but also enable controlling for these sources of variation. Additionally, having access to larger, multi-centre cohorts can also greatly help in training models that implicitly control for confounding factors associated with technical but inter-individual sources of variation.

\paragraph{Extending \ac{mile-vice}.} While using a relatively small and simple panel of morphometric features enables the identification of novel cellular archetypes, I note here that richer characterizations derived from \ac{dl} networks applied directly to images of blood cells can, in theory, capture more complex features. While autoencoders have shown promising results in these tasks \cite{Sommer2017-uj,Wei2021-gw}, it is also possible to derive features directly related to blood cell types by using large datasets of annotated images \cite{Matek2021-mp}. Additionally, it is worth noting that training \ac{mile-vice} with collections of images as input (instead of collections of vectors of morphometric features) is also a theoretical possibility which could discover even more specific \ac{vct}. The main caveat that the latter holds is how computationally expensive it is --- typically, well-performing predictive \ac{dl} models for image classification have millions of parameters and \ac{mil} requires each training step to process tens to hundreds of cell images. However, this is still feasible provided multiple \ac{gpu} cards are available, lowering the effective memory requirements for each individual \ac{gpu} card.

\section{Code availability and statistical analysis}

The code for different sections of this work is available across different repositories:

\begin{itemize}
    \item R scripts and code to train the elastic network regression model and the regularized random forest model, and generate figures is available in \url{https://github.com/josegcpa/wbs-prediction} under \texttt{analysis-plotting}
    \item The code to train, test and predict using \ac{mile-vice} is available in \url{https://github.com/josegcpa/wbs-prediction} under \texttt{mile-vice}
\end{itemize}

All statistical analyses were performed in R 3.6.3 \cite{R-core-team} --- \texttt{caret} was used to calculate cross-validated metrics \cite{Kuhn-2021-caret} and \texttt{pROC} was used to calculate \ac{auroc} \cite{Robin-2011-proc}. 
